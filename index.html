<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Martabak Loyalty System</title>
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator/qrcode.js"></script>
    
    <style>
        body { font-family: sans-serif; margin: 0; background: #f4f4f4; color: #333; }
        header { background: #d9534f; color: white; padding: 15px; text-align: center; }
        nav { background: #333; color: white; padding: 10px 0; text-align: center; }
        nav button { background: none; border: none; color: white; padding: 10px 15px; cursor: pointer; font-size: 16px; }
        nav button:hover { background: #555; }
        .container { padding: 20px; max-width: 900px; margin: auto; }
        .section { background: white; padding: 20px; margin-bottom: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        h2 { color: #d9534f; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-top: 0; }
        input[type="email"], input[type="password"], input[type="text"], input[type="number"], select {
            width: 100%; padding: 10px; margin: 8px 0; display: inline-block; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;
        }
        button { background: #5cb85c; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; margin-top: 10px; }
        button:hover { background: #4cae4c; }
        .btn-danger { background: #d9534f; }
        .btn-danger:hover { background: #c9302c; }
        .menu-list, .member-list, .inventory-list, .redeem-list { list-style: none; padding: 0; }
        .menu-item, .member-item, .inventory-item, .redeem-request { border: 1px solid #eee; padding: 15px; margin-bottom: 10px; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; }
        .price { font-weight: bold; color: #d9534f; }
        .alert { padding: 15px; margin-bottom: 15px; border-radius: 4px; }
        .alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .alert-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        #qr-code-display { text-align: center; margin-top: 20px; padding: 20px; border: 1px dashed #ccc; }
        .redeem-request button { margin-left: 10px; }
    </style>
</head>
<body>
    <header>
        <h1>Martabak Premium Loyalty System</h1>
    </header>

    <div class="container">
        <div id="loading" style="text-align: center; padding: 40px; display: none;">Memuat...</div>
        <div id="notification-area" class="alert" style="display: none;"></div>
        
        <section id="auth-section" class="section">
            <h2>Masuk / Daftar</h2>
            <input type="email" id="auth-email" placeholder="Email (cth: member@email.com)">
            <input type="password" id="auth-password" placeholder="Kata Sandi">
            <button onclick="handleLogin()">Masuk</button>
            <button onclick="handleRegister()">Daftar (Member Baru)</button>
            <p style="margin-top: 15px; font-size: 0.9em;">*Untuk Admin, gunakan email yang telah disetujui (cth: adminmartabak@martabakpremium.com).</p>
        </section>

        <section id="member-dashboard" class="section" style="display: none;">
            <nav>
                <button onclick="showMemberSection('member-profile')">Profil & Poin</button>
                <button onclick="showMemberSection('menu-member')">Menu</button>
                <button onclick="showMemberSection('redeem-member')">Tukar Poin</button>
                <button onclick="handleLogout()" class="btn-danger">Keluar</button>
            </nav>

            <div id="member-profile">
                <h2>Profil Member</h2>
                <p>Selamat datang, <strong id="member-name-display"></strong>!</p>
                <p>Email: <strong id="member-email-display"></strong></p>
                <p>Total Poin Anda: <strong id="member-points-display" style="font-size: 1.5em; color: #d9534f;"></strong></p>
                <button onclick="generateQR()">Tampilkan QR Code Poin (Scan oleh Admin)</button>
                <div id="qr-code-display"></div>
            </div>

            <div id="menu-member" style="display: none;">
                <h2>Daftar Menu Martabak</h2>
                <ul id="menu-list-member" class="menu-list">
                    </ul>
            </div>

            <div id="redeem-member" style="display: none;">
                <h2>Tukar Poin</h2>
                <p>Tukar 300 Poin untuk mendapatkan 1 Martabak Gratis!</p>
                <button onclick="requestRedeem(300, '1 Martabak Gratis')">Minta Penukaran 300 Poin</button>
                <h3>Riwayat Permintaan</h3>
                <ul id="redeem-history-member" class="redeem-list">
                    </ul>
            </div>
        </section>

        <section id="admin-dashboard" class="section" style="display: none;">
            <nav>
                <button onclick="showAdminSection('admin-home')">Home</button>
                <button onclick="showAdminSection('member-management')">Kelola Member</button>
                <button onclick="showAdminSection('redeem-requests')">Permintaan Tukar Poin</button>
                <button onclick="showAdminSection('inventory-management')">Inventaris Stok</button>
                <button onclick="handleLogout()" class="btn-danger">Keluar (Admin)</button>
            </nav>

            <div id="admin-home">
                <h2>Dashboard Admin</h2>
                <p>Selamat datang, Admin! Anda memiliki kontrol penuh.</p>
            </div>
            
            <div id="member-management" style="display: none;">
                <h2>Kelola Poin Member</h2>
                <p>Masukkan Email Member dan Poin yang akan ditambahkan/dikurangi:</p>
                <input type="email" id="add-points-email" placeholder="Email Member">
                <input type="number" id="points-amount" placeholder="Jumlah Poin (+50 atau -20)">
                <button onclick="addPoints()">Tambah/Kurangi Poin</button>
                <hr>
                <h3>Daftar Member</h3>
                <ul id="member-list-admin" class="member-list">
                    </ul>
            </div>

            <div id="redeem-requests" style="display: none;">
                <h2>Permintaan Penukaran Poin</h2>
                <ul id="redeem-requests-list" class="redeem-list">
                    </ul>
            </div>

            <div id="inventory-management" style="display: none;">
                <h2>Kelola Stok Inventaris</h2>
                <button onclick="showInventorySection('add-inventory')">Tambah Item Baru</button>
                <button onclick="showInventorySection('usage-history')">Catat Penggunaan Stok</button>
                <hr>
                <h3>Stok Saat Ini</h3>
                <ul id="inventory-list" class="inventory-list">
                    </ul>
                
                <div id="add-inventory" style="display: none;">
                    <h4>Tambah Stok Baru</h4>
                    <input type="text" id="inventory-name" placeholder="Nama Bahan (ex: Tepung Terigu)">
                    <input type="number" id="inventory-quantity" placeholder="Jumlah (ex: 50)">
                    <input type="text" id="inventory-unit" placeholder="Unit (ex: kg, liter, buah)">
                    <button onclick="addInventoryItem()">Simpan Item Baru</button>
                </div>

                <div id="usage-history" style="display: none;">
                    <h4>Catat Penggunaan Stok</h4>
                    <select id="usage-item-select">
                        <option value="">-- Pilih Item Stok --</option>
                    </select>
                    <input type="number" id="usage-amount" placeholder="Jumlah Digunakan (ex: 2.5)">
                    <button onclick="recordUsage()">Catat Penggunaan</button>
                    <hr>
                    <h5>Riwayat Penggunaan</h5>
                    <ul id="usage-history-list" class="inventory-list">
                        </ul>
                </div>
            </div>
        </section>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        import { getFirestore, collection, getDocs, doc, getDoc, setDoc, updateDoc, addDoc, query, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        // GANTI DENGAN KONFIGURASI PROYEK ANDA YANG BARU (Setelah Regenerasi Kunci API)
        const firebaseConfig = {
            apiKey: "GANTI_DENGAN_KUNCI_API_BARU_ANDA", // <-- GANTI DI SINI
            authDomain: "pendaftaran-martabak-572e0.firebaseapp.com", // GANTI SESUAI DOMAIN ANDA
            projectId: "pendaftaran-martabak-572e0", // GANTI SESUAI PROJECT ID ANDA
            storageBucket: "pendaftaran-martabak-572e0.appspot.com", // GANTI SESUAI BUCKET ANDA
            messagingSenderId: "374244242732",
            appId: "1:374244242732:web:1e35d1f86f37d383842c5c"
        };
        
        // Inisialisasi Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUserData = null; // Menyimpan data member/admin saat ini

        // ====================================================================
        // A. FUNGSI UTILITY (Notifikasi & Tampilan)
        // ====================================================================

        function showNotification(message, isError = false) {
            const area = document.getElementById('notification-area');
            area.textContent = message;
            area.className = isError ? 'alert alert-error' : 'alert alert-success';
            area.style.display = 'block';
            setTimeout(() => { area.style.display = 'none'; }, 5000);
        }

        function showSection(sectionId) {
            document.querySelectorAll('section').forEach(sec => sec.style.display = 'none');
            document.getElementById(sectionId).style.display = 'block';
        }

        function showMemberSection(id) {
            document.querySelectorAll('#member-dashboard > div').forEach(div => div.style.display = 'none');
            document.getElementById(id).style.display = 'block';
        }

        function showAdminSection(id) {
            document.querySelectorAll('#admin-dashboard > div').forEach(div => div.style.display = 'none');
            document.getElementById(id).style.display = 'block';
        }
        
        function showInventorySection(id) {
            document.querySelectorAll('#inventory-management > div').forEach(div => div.style.display = 'none');
            document.getElementById(id).style.display = 'block';
        }

        // ====================================================================
        // B. AUTENTIKASI (Login, Register, Logout)
        // ====================================================================

        window.handleRegister = async () => {
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            if (!email || !password) return showNotification("Email dan Kata Sandi wajib diisi.", true);

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                // 1. Buat dokumen baru di koleksi /members (default role: member)
                await setDoc(doc(db, "members", user.uid), {
                    email: user.email,
                    name: user.email.split('@')[0],
                    points: 0,
                    role: 'member',
                    createdAt: serverTimestamp()
                });
                showNotification("Pendaftaran berhasil! Silakan masuk.");
            } catch (error) {
                showNotification(`Gagal daftar: ${error.message}`, true);
            }
        };

        window.handleLogin = async () => {
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;

            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                showNotification(`Login Gagal: ${error.message}`, true);
            }
        };

        window.handleLogout = () => {
            signOut(auth);
            showNotification("Anda berhasil keluar.");
        };

        // ====================================================================
        // C. UTAMA: Cek Status Pengguna & Role
        // ====================================================================

        onAuthStateChanged(auth, async (user) => {
            document.getElementById('loading').style.display = 'block';
            if (user) {
                // Cek Role dari Custom Claim (Admin SDK)
                const idTokenResult = await user.getIdTokenResult(true); 
                const isAdmin = idTokenResult.claims.admin;
                
                // Ambil data dari Firestore
                const memberDoc = await getDoc(doc(db, "members", user.uid));
                currentUserData = memberDoc.exists() ? memberDoc.data() : { role: isAdmin ? 'admin' : 'member', points: 0, name: user.email, email: user.email }; // Fallback jika data member belum ada
                
                if (isAdmin) {
                    // Tampilkan Dashboard Admin
                    await loadAdminDashboard();
                    showSection('admin-dashboard');
                } else {
                    // Tampilkan Dashboard Member
                    await loadMemberDashboard();
                    showSection('member-dashboard');
                }

            } else {
                // Tidak ada pengguna login
                currentUserData = null;
                showSection('auth-section');
            }
            document.getElementById('loading').style.display = 'none';
        });

        // ====================================================================
        // D. DASHBOARD MEMBER (Fungsi Khusus)
        // ====================================================================

        async function loadMemberDashboard() {
            document.getElementById('member-name-display').textContent = currentUserData.name || 'Member';
            document.getElementById('member-email-display').textContent = currentUserData.email;
            document.getElementById('member-points-display').textContent = currentUserData.points.toLocaleString('id-ID');
            await loadMenu('menu-list-member');
            await loadMemberRedeemHistory(auth.currentUser.uid);
            showMemberSection('member-profile');
        }

        window.generateQR = () => {
            const qrData = auth.currentUser.uid;
            const qrDiv = document.getElementById('qr-code-display');
            qrDiv.innerHTML = '';
            
            // Buat instance QR Code
            const qr = qrcode(4, 'M'); // 4: versi, M: level koreksi error
            qr.addData(qrData);
            qr.make();
            
            // Tampilkan sebagai gambar
            const qrImg = qr.createImgTag(5, 10, 'QR Code Poin'); // 5: ukuran pixel, 10: margin
            qrDiv.innerHTML = `<h4>Tunjukkan ini ke Admin:</h4>${qrImg}`;
        };

        async function loadMenu(listId) {
            const list = document.getElementById(listId);
            list.innerHTML = ''; // Kosongkan daftar
            
            try {
                const querySnapshot = await getDocs(collection(db, "menu"));
                
                if (querySnapshot.empty) {
                    list.innerHTML = '<li>Belum ada menu yang tersedia.</li>';
                    return;
                }

                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const li = document.createElement('li');
                    
                    // PENTING: data.price harus Number untuk .toLocaleString()
                    const formattedPrice = data.price ? data.price.toLocaleString('id-ID', { style: 'currency', currency: 'IDR' }) : 'Harga Tidak Ada';
                    
                    li.className = 'menu-item';
                    li.innerHTML = `
                        <div>
                            <strong>${data.name}</strong> 
                            <p style="font-size: 0.9em; color: #666;">${data.description || ''}</p>
                        </div>
                        <span class="price">${formattedPrice}</span>
                    `;
                    list.appendChild(li);
                });
            } catch(error) {
                // Error 400 akan muncul di console, ini mencegah UI crash.
                list.innerHTML = `<li class="alert-error">Gagal memuat menu: ${error.message}. Cek koneksi Firebase Anda.</li>`;
            }
        }

        window.requestRedeem = async (points, item) => {
            if (currentUserData.points < points) {
                return showNotification(`Gagal: Poin Anda (${currentUserData.points}) tidak cukup. Dibutuhkan ${points} Poin.`, true);
            }

            try {
                await addDoc(collection(db, "redeem_requests"), {
                    memberId: auth.currentUser.uid,
                    memberName: currentUserData.name,
                    item: item,
                    pointsCost: points,
                    status: 'pending',
                    timestamp: serverTimestamp()
                });
                showNotification("Permintaan penukaran berhasil diajukan! Tunggu konfirmasi Admin.");
                await loadMemberRedeemHistory(auth.currentUser.uid); // Muat ulang riwayat
            } catch (error) {
                showNotification(`Gagal mengajukan permintaan: ${error.message}`, true);
            }
        };

        async function loadMemberRedeemHistory(memberId) {
            const list = document.getElementById('redeem-history-member');
            list.innerHTML = '<li>Memuat...</li>';
            
            const q = query(collection(db, "redeem_requests"), where("memberId", "==", memberId));
            const snapshot = await getDocs(q);
            list.innerHTML = '';

            if (snapshot.empty) {
                list.innerHTML = '<li>Belum ada riwayat penukaran.</li>';
                return;
            }

            snapshot.forEach(doc => {
                const data = doc.data();
                const li = document.createElement('li');
                li.className = 'redeem-request';
                li.innerHTML = `
                    <div>
                        <strong>${data.item} (${data.pointsCost} Poin)</strong>
                        <span style="color: ${data.status === 'approved' ? 'green' : data.status === 'pending' ? 'orange' : 'red'}; margin-left: 10px;">Status: ${data.status.toUpperCase()}</span>
                    </div>
                `;
                list.appendChild(li);
            });
        }


        // ====================================================================
        // E. DASHBOARD ADMIN (Fungsi Khusus)
        // ====================================================================

        async function loadAdminDashboard() {
            await loadAllMembers();
            await loadRedeemRequests();
            await loadInventory();
            await loadUsageHistory();
            showAdminSection('admin-home');
        }

        window.addPoints = async () => {
            const email = document.getElementById('add-points-email').value;
            const amount = parseInt(document.getElementById('points-amount').value);

            if (!email || isNaN(amount) || amount === 0) {
                return showNotification("Email dan Jumlah Poin wajib diisi.", true);
            }

            try {
                // 1. Cari Member berdasarkan email
                const q = query(collection(db, "members"), where("email", "==", email));
                const snapshot = await getDocs(q);

                if (snapshot.empty) {
                    return showNotification("Member tidak ditemukan.", true);
                }

                const memberDoc = snapshot.docs[0];
                const memberRef = memberDoc.ref;
                const currentPoints = memberDoc.data().points;
                const newPoints = currentPoints + amount;

                // 2. Update Poin Member
                await updateDoc(memberRef, { points: newPoints });

                // 3. Catat Transaksi
                await addDoc(collection(db, "point_transactions"), {
                    memberId: memberDoc.id,
                    type: amount > 0 ? 'ADD' : 'DEDUCT',
                    points_change: amount,
                    new_points_balance: newPoints,
                    timestamp: serverTimestamp()
                });
                
                showNotification(`Poin ${email} berhasil diubah sebesar ${amount}. Poin baru: ${newPoints}.`);
                await loadAllMembers(); // Muat ulang daftar member
            } catch (error) {
                showNotification(`Gagal mengubah poin: ${error.message}`, true);
            }
        };

        async function loadAllMembers() {
            const list = document.getElementById('member-list-admin');
            list.innerHTML = '<li>Memuat...</li>';
            
            const snapshot = await getDocs(collection(db, "members"));
            list.innerHTML = '';

            snapshot.forEach(doc => {
                const data = doc.data();
                const li = document.createElement('li');
                li.className = 'member-item';
                li.innerHTML = `
                    <div>
                        <strong>${data.name || data.email}</strong> 
                        <p style="font-size: 0.9em;">Email: ${data.email}</p>
                    </div>
                    <span>Poin: ${data.points.toLocaleString('id-ID')}</span>
                `;
                list.appendChild(li);
            });
        }

        async function loadRedeemRequests() {
            const list = document.getElementById('redeem-requests-list');
            list.innerHTML = '<li>Memuat...</li>';
            
            const q = query(collection(db, "redeem_requests"), where("status", "==", "pending"));
            const snapshot = await getDocs(q);
            list.innerHTML = '';

            if (snapshot.empty) {
                list.innerHTML = '<li>Tidak ada permintaan penukaran yang tertunda.</li>';
                return;
            }

            snapshot.forEach(doc => {
                const data = doc.data();
                const li = document.createElement('li');
                li.className = 'redeem-request';
                li.innerHTML = `
                    <div>
                        <strong>${data.item}</strong> dari ${data.memberName || 'Member'} (${data.pointsCost} Poin)
                    </div>
                    <div>
                        <button onclick="handleRedeemAction('${doc.id}', '${data.memberId}', ${data.pointsCost}, 'approved')" style="background: green;">Setujui</button>
                        <button onclick="handleRedeemAction('${doc.id}', '${data.memberId}', ${data.pointsCost}, 'rejected')" class="btn-danger">Tolak</button>
                    </div>
                `;
                list.appendChild(li);
            });
        }

        window.handleRedeemAction = async (requestId, memberId, pointsCost, status) => {
            const memberRef = doc(db, 'members', memberId);
            const requestRef = doc(db, 'redeem_requests', requestId);

            try {
                if (status === 'approved') {
                    // Cek dan Kurangi Poin Member (Transaksi Kritis)
                    const memberSnap = await getDoc(memberRef);
                    const currentPoints = memberSnap.data().points;
                    const newPoints = currentPoints - pointsCost;
                    
                    if (newPoints < 0) {
                         return showNotification(`Gagal: Poin Member tidak cukup untuk penukaran ini.`, true);
                    }
                    
                    await updateDoc(memberRef, { points: newPoints });

                    // Catat Transaksi Pengurangan
                    await addDoc(collection(db, 'point_transactions'), { 
                        memberId: memberId, 
                        type: 'REDEEM', 
                        points_change: -pointsCost, 
                        new_points_balance: newPoints, 
                        description: `Penukaran Poin Disetujui`, 
                        timestamp: serverTimestamp() 
                    });
                }

                // Update Status Permintaan
                await updateDoc(requestRef, { status: status });
                showNotification(`Permintaan penukaran ${memberId} berhasil di ${status}.`);
                await loadRedeemRequests(); // Muat ulang daftar
            } catch (error) {
                showNotification(`Aksi gagal: ${error.message}`, true);
            }
        };

        // --- Inventaris (Stok) ---

        window.addInventoryItem = async () => {
            const name = document.getElementById('inventory-name').value;
            const quantity = parseFloat(document.getElementById('inventory-quantity').value);
            const unit = document.getElementById('inventory-unit').value;

            if (!name || isNaN(quantity) || !unit) {
                return showNotification("Semua field wajib diisi.", true);
            }

            try {
                await addDoc(collection(db, "inventory"), {
                    name: name,
                    quantity: quantity,
                    unit: unit,
                    createdAt: serverTimestamp()
                });
                showNotification(`Item ${name} berhasil ditambahkan ke inventaris.`);
                await loadInventory();
            } catch (error) {
                showNotification(`Gagal menambah item: ${error.message}`, true);
            }
        };
        
        async function loadInventory() {
            const list = document.getElementById('inventory-list');
            const select = document.getElementById('usage-item-select');
            list.innerHTML = '<li>Memuat...</li>';
            select.innerHTML = '<option value="">-- Pilih Item Stok --</option>';

            const snapshot = await getDocs(collection(db, "inventory"));
            list.innerHTML = '';

            snapshot.forEach(doc => {
                const data = doc.data();
                const li = document.createElement('li');
                li.className = 'inventory-item';
                li.innerHTML = `
                    <div>
                        <strong>${data.name}</strong> 
                        <p style="font-size: 0.9em; color: #666;">Stok: ${data.quantity} ${data.unit}</p>
                    </div>
                `;
                list.appendChild(li);
                
                // Isi dropdown untuk Catat Penggunaan
                const option = document.createElement('option');
                option.value = doc.id;
                option.textContent = `${data.name} (${data.unit})`;
                select.appendChild(option);
            });
        }

        window.recordUsage = async () => {
            const itemId = document.getElementById('usage-item-select').value;
            const amountUsed = parseFloat(document.getElementById('usage-amount').value);

            if (!itemId || isNaN(amountUsed) || amountUsed <= 0) {
                return showNotification("Pilih item dan masukkan jumlah yang digunakan.", true);
            }

            try {
                const itemRef = doc(db, 'inventory', itemId);
                const itemSnap = await getDoc(itemRef);
                
                if (!itemSnap.exists()) return showNotification("Item tidak ditemukan.", true);

                const data = itemSnap.data();
                const currentQty = data.quantity;
                
                if (currentQty < amountUsed) {
                     return showNotification(`Gagal: Stok ${data.name} hanya ${currentQty} ${data.unit}.`, true);
                }

                const newQty = currentQty - amountUsed;
                
                // 1. Kurangi Stok
                await updateDoc(itemRef, { quantity: newQty });

                // 2. Catat Riwayat Penggunaan
                await addDoc(collection(db, "usage_history"), {
                    itemId: itemId,
                    itemName: data.name,
                    amountUsed: amountUsed,
                    unit: data.unit,
                    timestamp: serverTimestamp()
                });

                showNotification(`Penggunaan ${amountUsed} ${data.unit} ${data.name} berhasil dicatat. Stok tersisa: ${newQty}.`);
                await loadInventory(); // Muat ulang inventaris
                await loadUsageHistory(); // Muat ulang riwayat
            } catch (error) {
                showNotification(`Gagal mencatat penggunaan: ${error.message}`, true);
            }
        };

        async function loadUsageHistory() {
             const list = document.getElementById('usage-history-list');
             list.innerHTML = '<li>Memuat...</li>';
             
             // Query 10 riwayat terakhir (Opsional: Urutkan berdasarkan timestamp)
             const snapshot = await getDocs(collection(db, "usage_history"));
             list.innerHTML = '';

             if (snapshot.empty) {
                list.innerHTML = '<li>Belum ada riwayat penggunaan stok.</li>';
                return;
             }

             snapshot.forEach(doc => {
                const data = doc.data();
                const li = document.createElement('li');
                li.className = 'inventory-item';
                li.innerHTML = `
                    <div>
                        <strong>${data.itemName}</strong> 
                        <p style="font-size: 0.9em;">Digunakan: ${data.amountUsed} ${data.unit}</p>
                    </div>
                `;
                list.appendChild(li);
             });
        }
    </script>
</body>
</html>
